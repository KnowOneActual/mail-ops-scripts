import xml.etree.ElementTree as ET
from datetime import datetime
import sys
import gzip
import zipfile
import os

def parse_dmarc_xml(file_path):
    """
    Parses a DMARC aggregate report (XML, .gz, or .zip) and prints a summary.
    """
    tree = None
    
    # 1. Open the file based on extension
    try:
        if file_path.endswith('.gz'):
            with gzip.open(file_path, 'rb') as f:
                tree = ET.parse(f)
        elif file_path.endswith('.zip'):
            with zipfile.ZipFile(file_path, 'r') as z:
                # Find the first XML file in the zip
                xml_files = [n for n in z.namelist() if n.lower().endswith('.xml')]
                if not xml_files:
                    print(f"Error: No XML file found inside '{file_path}'")
                    return
                # Parse the first XML found
                with z.open(xml_files[0]) as f:
                    tree = ET.parse(f)
        else:
            # Assume standard XML file
            tree = ET.parse(file_path)
            
        root = tree.getroot()
        
    except FileNotFoundError:
        print(f"Error: File '{file_path}' not found.")
        return
    except Exception as e:
        print(f"Error processing '{file_path}': {e}")
        return

    # 2. Extract Metadata
    org_name = root.findtext('.//org_name') or "Unknown Org"
    
    date_range = root.find('.//date_range')
    if date_range is not None:
        begin_ts = int(date_range.findtext('begin', 0))
        end_ts = int(date_range.findtext('end', 0))
        begin_date = datetime.fromtimestamp(begin_ts).strftime('%Y-%m-%d %H:%M')
        end_date = datetime.fromtimestamp(end_ts).strftime('%Y-%m-%d %H:%M')
    else:
        begin_date = end_date = "Unknown"

    print(f"--- Report for {org_name} ---")
    print(f"Period: {begin_date} to {end_date}")
    print("-" * 65)
    print(f"{'Source IP':<20} | {'Count':<5} | {'SPF':<6} | {'DKIM':<6} | {'Disposition'}")
    print("-" * 65)

    # 3. Extract Records
    records = root.findall('record')
    
    if not records:
        print("No traffic records found (likely a policy check only).")
        return

    for record in records:
        row = record.find('row')
        source_ip = row.findtext('source_ip')
        count = row.findtext('count')
        
        # Policy Applied
        disposition = row.find('.//policy_evaluated/disposition').text
        
        # Auth Results
        spf = record.find('.//auth_results/spf/result')
        spf_res = spf.text if spf is not None else "none"
        
        dkim = record.find('.//auth_results/dkim/result')
        dkim_res = dkim.text if dkim is not None else "none"

        print(f"{source_ip:<20} | {count:<5} | {spf_res:<6} | {dkim_res:<6} | {disposition}")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python dmarc_parser.py <path_to_report>")
    else:
        parse_dmarc_xml(sys.argv[1])